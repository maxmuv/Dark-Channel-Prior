# Dark-Channel-Prior
### Технические требования

Для запуска программы:
    
    cmake >= 3.12

    OpenCV >= 4.0

    Компилятор, поддерживающий 17-ый стандарт C++

Для запуска скриптов на python:
	
    python >= 3.7
	
### Установка

```console
    git clone https://github.com/maxmuv/Dark-Channel-Prior.git
    
    cd Dark-Channel-Prior/build

    cmake ..

    cmake --build . --target install --config Release
```

В директории *build* должна появиться основная программа *HazeMachine[.exe]*. Стоит также перед запуском убедиться, что проходят тесты:

```console
    ctest -C Release
```

### Использование 

Для аугментации:

```console
    [./]HazeModel[.exe] <hazy> <images> <maps>
```

\<hazy\> - директория, куда сохранятся картинки с аугментированной дымкой, она должна существовать и быть пустой, \<images\> и \<maps\> - директории с изображениями и картами глубины, соответственно. Соответствующие изображения должны иметь одинаковое название. В директории с результатом соответсвующее изображение получает такое-же название. 

Для удаления тумана:

```console
    [./]HazeModel[.exe] <dcp> <hazy> 
```

\<dcp\> - директория, куда сохраняются картинки с удаленным туманом, должна существовать и быть пустой. \<hazy\> - директория с изображениями с туманом. Итоговая картинка с удаленным туманом будет иметь такое же название, как и соответствующая ей с туманом.

(Кириллица и пробелы в путях не допускаются программой)

### Составные части проекта
#### Программы
##### HaseModel
Производит аугментацию и удаляет туман, работает только лишь с директориями.

#### Библиотеки
##### HazeModel
Статическая библиотека для аугментации и удаления тумана. В ней реализованы класс HazeModel и функция CreateTransmission. Объект HazeModel содержит передачу цвета от объектов(transmission, $t(x)$ ), свет атмосферы(atmosphere's light, $\vec{A}$) и минимальную передачу($t_0$). Он добавляет дымку на трехканальное изображение типа double или снимает с него согласно параметрам по следующей формуле:

$$\vec{I}(x) = \vec{J}(x) t(x) + \vec{A}(1 - t(x))$$  

Функция по одноканальной матрице типа double, проинициализированной картой глубины $d(x)$ и параметру $\beta$ создает передачу согласно формуле:

$$t(x) = e^{-\beta d(x)}.$$

Во всех функциях библиотеки использую матрицы типа double cv::Mat с диапозоном значений (0, 1).

###### Тесты
* *test_haze_model* - тест для класса HazeModel и его методов. Методы тестируются на небольших матрицах, результаты для которых легко посчитать вручную. Полученные матрицы сравниваются с посчитанными.

* *test_transmission_creation* - аналогично для функции CreateTransmission.

* *test_sample* - одновременно тест на проверку базовой роботоспособности и пример работы на реальной картинке. В папке sample лежат изображение из [2], карта глубины и результат аугментации и снятия дымки (со знанием передачи и атмосферного света). 

##### DCP
Статическая библиотека для оценки передачи и атмосферного света. Реализованы три функции - DarkChannel, EstimateAtmosphericLight и EstimateTransmission, согласно работе [1]. Функция SoftMatting была написана, но не до конца отлажена(код лежит в dcp.cpp и закомментирован), поэтому итоговые изображения получаются с мелкой структурой от DarkChannel алгоритма. Один из основных параметров функций - размер патчей, по которым считается темный канал. В функциях Исполнителя выставлен в 15, аналогично работе [1]. Остальные параметры аналогичны работе. 

##### Тесты 
* *test_dcp* - для проверки DarkChannel и EstimateAtmospericLight используется небольшая матрица размера 2 на 3, при этом патч для подсчета темных каналов имеет размер 3(проверяет, что в углах посчитается все верно). Для проверки EstimateAtmosphericLight используется также простая матрица.

##### Executor
Статическая библиотека с одноименным классом. Класс реализует логику программы с использованием других библиотек, а также проверяет корректность картинок. Хранит в себе параметры для аугментации и удаления тумана.

* Для аугментации:
    + интенсивность атмосферного света : $[0.3, 0.7]$ из равномерного распределения. Предполагаю, что свет атмосферы серый.
    + $\beta \in [1.5, 3.0]$ из равномерного распределения(более менее насыщенный туман), значение карты глубины $\in [0.3, 1]$, для придачи в близи небольшой дымки. То есть итоговая передача от около 5% до примерно 63%.

* Для удаления тумана:
    + размер патча - 15.

Также написана функция Produce - ее и использует HazeModel, данная функция подгружает картинки, запускает Исполнителя и сохраняет результаты.

###### Тесты
* *test_executor* -простой тест на то, что программа бросает или не бросает исключения, а также правильно отслеживает глубину и размер картинок.

##### ImageLoader
Статическая библиотека, чтобы отделить std::filesystem от остальных частей проекта. В ней реализованы обертка над путями из std::filesystem, а также функция, которая формирует список путей файлов в директории в лексиграфическом порядке. Также реализована функция для загрузки изображений, в том числе и для путей в формате UTF-8. 

###### Тесты
* *test_image_loader* - тест, который проверяет правильность составления списка путей файлов в тестовой директории. 

#### Сторонние header-only библиотеки-хедера
##### Doctest
Используется для тестирования.

### Используемые скрипты на python

Скрипты лежат в поддиректории pyscripts директории с исходниками. Перед использованием скриптов стоит установить зависимости:

```console
    pip install -r requirements.txt
```

Сами скрипты:

* *diode_sampler.py* - скрипт, который для outdoor директории датасета DIODE[2] создает в выходной директории две папки, одна из которых - с изображениями, другая - с картами глубины, сохраненными в виде серых изображений. В [2] использовался сенсор с диапазоном в 0.5-350м, поэтому для неба и некоторый движущихся объектов значения получились невалидными. Для этих пикселей в картах глубины сделал значение, равной максимальной глубине. Картинки и карты глубины для аугментации были скопированы/сделаны из сплита DIODE для валидации.

```console
    python3 diode_sampler.py <outdoor_input_dir> <output_dir> 50
```

* *horizon_mapper.py* - скрипт, используемый на изображениях с горизонтом, собранных со стока свободных изображений https://unsplash.com/ . Скрипт создает грубую карту глубины. Делается бинаризация алгоритмом Отсу, которая неплохо разделяет небо от остального изображения. Затем находиться наибольшая компонента связности, предполагая, что небо занимает наибольшую площадь. А затем, исходя из знания того, что то, что снизу на изображении ближе, чем то, что выше, делается равномерный переход в каждом столбце от нижнего пикселя к участку с небом, а небо продолжает доверху. Из-за прямого обращения к пикселям работает относительно долго.

```console
    python3 horizon_mapper.py <images> <maps>
```

* *o-haze_renamer.py* - скрипт, который в директориях датасета O-HAZE[3] переименовывает изображения, чтобы имена соответствующих картинок были одинаковы.

```console
    python3 o-haze_renamer.py <o_haze_dir>
```

* *comparator.py* - скрипт, который вычисляет ssim и mse между изображениями двух директорий, а также выводит среднее. Меры вычисляются с помощью функций пакета skikit-image.

```console
    python3 comparator.py <lhs_dir> <rhs_dir>
```

### Примеры 

Приведены в приложении 1.

### Описание датасетов.

Всего использовалось 3 типа данных:

1. Аугментированные с помощью карт глубины(50 изображений). Данные взяты из сплита для валидации открытого датасета DIODE[2] (https://diode-dataset.org/). Для отображения карт глубины в изображения был написан скрипт *diode_sampler.py*

2. Аугментированные с помощью приближенной карты глубины(47 изображений). Данные взяты с сайта (https://unsplash.com/). Для создания карт глубины использовался скрипт *horizon_mapper.py*

3. Реальные данные(35 картинок). Датасет - O-HAZE [3]. Его сайт - https://data.vision.ee.ethz.ch/cvl/ntire18/o-haze/ . Плюсом является то, что в нем имеется ground truth, потому что для создания тумана использовалась специальная машина для создания тумана и снимки были сделаны до и после ее использования. Для переименовывания файлов использовался скрипт *o-haze_renamer.py*.

Каждому типу данных соответстует своя директория в data: diode, unsplash, o-haze, соответственно.

В каждой директории 4 поддиректории - images(оригинальные изображения без тумана), map(изображения карт глубины, сделанные скриптами, кроме o-haze), hazy(изображения с туманом), dcp(восстановленные изображения с помощью Dark Channel Prior).  

### Тестирование

Приложение собрано и протестировано на:

1. ###### Ubuntu:

    *Из консоли*:

        CMake - 3.26.1

        Генератор - Unix Makefiles

        Компилятор - GNU 11.3.0

        OpenCV - 4.7.0

2. ###### Windows:

    *Из консоли*:

        Генератор CMake - "Visual Studio 15 2017"

        CMake - 3.20.1

        MSVC - 19.16.27045.0

        OpenCV - 4.5.5

Скрипты запускались только на Ubuntu.

### Ссылки:

1. He K., Sun J., Tang X. Single image haze removal using dark channel prior //IEEE transactions on pattern analysis and machine intelligence. – 2010. – Т. 33. – №. 12. – С. 2341-2353.

2. Vasiljevic I. et al. Diode: A dense indoor and outdoor depth dataset //arXiv preprint arXiv:1908.00463. – 2019.

3. Ancuti C. O. et al. O-haze: a dehazing benchmark with real hazy and haze-free outdoor images //Proceedings of the IEEE conference on computer vision and pattern recognition workshops. – 2018. – С. 754-762.

### Приложение 1

Входное изображение из датасета DIODE[2] c картой глубины - изображения 1-2.

![Input image](result_pdf/00022_00193_outdoor_000_000.png){ width=200 }

![Depth map](result_pdf/00022_00193_outdoor_000_000(1).png){ width=200 }

После аугментации - Изображение 3.

![Augmented image](result_pdf/00022_00193_outdoor_000_000_result.png){ width=200 }
