# Dark-Channel-Prior
### Технические требования

Для запуска скриптов на python:
	python >= 3.7
	
### Установка

```console
    git clone https://github.com/maxmuv/Dark-Channel-Prior.git
    
    cd Dark-Channel-Prior/build

    cmake ..

    cmake --build . --target install --config Release
```

В директории *build* должна появиться основная программа *HazeMachine[.exe]*. Стоит также перед запуском убедиться, что проходят тесты:

```console
    ctest -C Release
```

### Использование 

Для аугментации:

```console
    [./]HazeModel[.exe] <result_dir> <image_dir> <depth_map_dir>
```

   \<result_dir\> - должна существовать и быть пустой, \<image_dir\> и \<depth_map_dir\> - директории с изображениями и картами глубины, соответственно. Соответствующие изображения должны иметь одинаковое название. И в директории с результатом соответсвующее изображение получает такое-же название. 

### Составные части проекта
#### Программы
##### HaseModel
Производит аугментацию и удаляет туман, работает только лишь с директориями.

#### Библиотеки
##### HazeModel
Статическая библиотека для аугментации и удаления тумана. В ней реализованы класс HazeModel и функция CreateTransmission. Объект HazeModel содержит передачу цвета от объектов(transmission, $t(x)$ ), свет атмосферы(atmosphere's light, $\vec{A}$) и минимальную передачу($t_0$). Он добавляет дымку на трехканальное изображение типа double или снимает с него согласно параметрам по следующей формуле:

$$\vec{I}(x) = \vec{J}(x) t(x) + \vec{A}(1 - t(x))$$  

Функция по одноканальной матрице типа double, проинициализированной картой глубины $d(x)$ и параметру $\beta$ создает передачу согласно формуле:

$$t(x) = e^{-\beta d(x)}.$$

Во всех функциях библиотеки использую матрицы типа double cv::Mat с диапозоном значений (0, 1).

###### Тесты
* *test_haze_model* - тест для класса HazeModel и его методов. Методы тестируются на небольших матрицах, результат для которых легко посчитать вручную. Полученные матрицы сравниваются с изначально посчитанными.

* *test_transmission_creation* - аналогично для функции CreateTransmission.

* *test_sample* - одновременно тест на проверку базовой роботоспособности и пример работы на реальных картинках. В папке sample лежат изображение из [2], карта глубины и результат аугментации и снятия дымки (со знанием передачи и атмосферного света). 

##### Executor
Статическая библиотека с одноименным классом. Класс реализует логику программы с использованием других библиотек, а также проверяет корректность картинок. Хранит в себе параметры для аугментации и удаления тумана.

* Для аугментации:
    + интенсивность атмосферного света : $[0.3, 0.7]$ из равномерного распределения. Предполагаю, что свет атмосферы серый.
    + $\beta \in [1.5, 3.0]$ из равномерного распределения(более менее насыщенный туман), значение карты глубины $\in [0.3, 1]$, для придачи в близи небольшой дымки. То есть итоговая передача от около 5% до примерно 63%.

Также написана функция Produce - ее и использует HazeModel, она подгружает картинки, запускает Исполнителя и сохраняет результаты.

###### Тесты
* *test_executor* -простой тест на то, что программа бросает или не бросает исключения, а также правильно отслеживает формат картинок.

##### ImageLoader
Статическая библиотека, чтобы отделить std::filesystem от остальных частей проекта. В ней реализованы обертка над путями из std::filesystem, а также функция, которая формирует список путей файлов в директории в лексиграфическом порядке. Также реализована функция для загрузки изображений, в том числе и для путей в формате UTF-8. 

###### Тесты
* *test_image_loader* - тест, который проверяет правильность составления списка путей файлов в тестовой директории. 

#### Сторонние header-only библиотеки-хедера
##### Doctest
Используется для тестирования.

### Используемые скрипты на python

Лежат в директории pyscripts. Перед использованием скриптов стоит установить зависимости:

```console
    pip install -r requirements.txt
```

Сами скрипты:

* *diode_sampler.py* - скрипт, который для outdoor директории датасета DIODE[2] создает в выходной директории две папки, одна из которых - с изображениями, другая - с картами глубины, сохраненными в виде серых изображений. В [2] использовался сенсор с диапазоном в 0.5-350м, поэтому для неба и некоторый движущихся объектов значения получились невалидными. Для этих пикселей в картах глубины сделал значение, равной максимальной глубине. Картинки и карты глубины для аугментации были сделаны из сплита DIODE для валидации.

* *horizon_mapper.py* - скрипт, используемый на изображениях с горизонтом, собранных со стока свободных изображений https://unsplash.com/ . Скрипт создает грубую карту глубины. Делается бинаризация алгоритмом Отсу, которая неплохо разделяет небо от остального изображения. Затем находиться наибольшая компонента связности. А затем, исходя из знания того, что то, что снизу ближе, чем то,что выше на изображении, делается равномерный переход в каждом столбце от низа к небу, а небо продолжаем доверху. Из-за прямого обращения к пикселям работает относительно долго.

### Примеры 
Входное изображение из датасета DIODE[2] c картой глубины - изображения 1-2.

![Input image](result_pdf/00022_00193_outdoor_000_000.png){ width=200 }

![Depth map](result_pdf/00022_00193_outdoor_000_000(1).png){ width=200 }

После аугментации - Изображение 3.

![Augmented image](result_pdf/00022_00193_outdoor_000_000_result.png){ width=200 }

### Тестирование

Приложение собрано и протестировано на:

1. ###### Linux(Ubuntu):

    *Из консоли*:

        CMake - 3.26.1

        Генератор - Unix Makefiles

        Компилятор - GNU 11.3.0

        OpenCV - 4.7.0

2. ###### Windows:

    *Visual Studio Code*:

        Генератор CMake - "Visual Studio 15 2017"

        CMake - 3.20.1

        MSVC - 19.16.27045.0

        OpenCV - 4.5.5

    *Из консоли*:

        Генератор CMake - "Visual Studio 15 2017"

        CMake - 3.20.1

        MSVC - 19.16.27045.0

        OpenCV - 4.5.5

### Ссылки:

2. Vasiljevic I. et al. Diode: A dense indoor and outdoor depth dataset //arXiv preprint arXiv:1908.00463. – 2019.